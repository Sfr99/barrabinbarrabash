{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="row">
    <div class="card">
        <h2>Ataques hoy</h2>
        <p class="big-number">{{ attacks_today }}</p>

        <form method="post" action="{{ url_for('reset') }}">
            <button type="submit" class="btn btn-danger">
                Reset contador y estado
            </button>
        </form>
    </div>

    <div class="card">
        <h2>IPs baneadas</h2>
        {% if banned_ips %}
        <table>
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Motivo</th>
                    <th>Baneado desde</th>
                </tr>
            </thead>
            <tbody>
            {% for ban in banned_ips %}
                <tr>
                    <td>{{ ban.ip }}</td>
                    <td>{{ ban.reason }}</td>
                    <td>{{ ban.since }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No hay IPs baneadas.</p>
        {% endif %}
        <a href="{{ url_for('bans') }}" class="btn">Ver y gestionar bans</a>
    </div>
</section>

<section class="card">
    <h2>Eventos por minuto (últimos 10 min)</h2>
    <div class="chart-container">
        <canvas id="eventsChart"></canvas>
    </div>
</section>

<section class="card">
    <h2>Últimos eventos</h2>

    {% if events %}
    <table>
        <thead>
            <tr>
                <th>Hora</th>
                <th>IP</th>
                <th>Acción</th>
                <th>Descripción</th>
            </tr>
        </thead>
        <tbody>
        {% for ev in events %}
            <tr>
                <td>{{ ev.timestamp }}</td>
                <td>{{ ev.ip }}</td>
                <td>{{ ev.action }}</td>
                <td>{{ ev.description }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No hay eventos registrados.</p>
    {% endif %}
</section>

<script>
let chart = null;

function createChart(labels, values) {
    const ctx = document.getElementById("eventsChart");

    if (chart) {
        chart.destroy();
    }

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Eventos",
                data: values,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                y: {
                    beginAtZero: true,
                    precision: 0
                }
            }
        }
    });
}

function fetchChartData() {
    fetch("http://127.0.0.1:8001/chart")
        .then(resp => resp.json())
        .then(data => {
            chart.data.labels = data.labels;
            chart.data.datasets[0].data = data.values;
            chart.update("none");
        })
        .catch(err => console.error("Error actualizando chart:", err));
}

// Inicial
createChart(
    JSON.parse('{{ chart_labels | tojson | safe }}'),
    JSON.parse('{{ chart_values | tojson | safe }}')
);

setInterval(fetchChartData, 5000);
</script>

{% endblock %}
