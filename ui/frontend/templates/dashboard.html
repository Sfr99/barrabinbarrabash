{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="row">
    <div class="card">
        <h2>Ataques hoy</h2>
        <p class="big-number">{{ attacks_today }}</p>

        <form method="post" action="{{ url_for('reset') }}">
            <button type="submit" class="btn btn-danger">
                Reset Counter and State
            </button>
        </form>
    </div>

    <div class="card">
        <h2>Banned IPs</h2>

        {% if banned_ips %}
        <div class="banned-table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>IP</th>
                        <th>Reason</th>
                        <th>Banned Since</th>
                    </tr>
                </thead>
                <tbody id="banned-table-body">
                {% for ban in banned_ips %}
                    <tr>
                        <td>{{ ban.ip }}</td>
                        <td>{{ ban.reason }}</td>
                        <td>{{ ban.since }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p>No banned IPs.</p>
        {% endif %}

        <a href="{{ url_for('bans') }}" class="btn">View and Manage Bans</a>
    </div>

</section>

<section class="card">
    <h2>Events Per Minute</h2>
    <div class="chart-container">
        <canvas id="eventsChart"></canvas>
    </div>
</section>

<section class="card">
    <h2>Last Events</h2>

    {% if events %}
    <table>
        <thead>
            <tr>
                <th>Hour</th>
                <th>IP</th>
                <th>Action</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody id="events-table-body">
        {% for ev in events %}
            <tr>
                <td>{{ ev.timestamp }}</td>
                <td>{{ ev.ip }}</td>
                <td>{{ ev.action }}</td>
                <td>{{ ev.description }}</td>
            </tr>
        {% endfor %}
        </tbody>


    </table>
    {% else %}
        <p>No registred events.</p>
    {% endif %}
</section>

<script>
let chart = null;

// -------------------- CHART --------------------

function createChart(labels, values) {
    const ctx = document.getElementById("eventsChart");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Events",
                data: values,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                y: {
                    beginAtZero: true,
                    precision: 0
                }
            }
        }
    });
}

// -------------------- DOM UPDATE LOGIC --------------------
function updateAttacksToday(value) {
    const el = document.querySelector(".big-number");
    if (el) el.textContent = value;
}

function updateBannedIPs(list) {
    const tbody = document.querySelector("#banned-table-body");
    if (!tbody) return;

    if (!list || list.length === 0) {
        tbody.innerHTML = "";
        return;
    }

    tbody.innerHTML = list.map(b => `
        <tr>
            <td>${b.ip}</td>
            <td>${b.reason}</td>
            <td>${b.since}</td>
        </tr>
    `).join("");
}

function updateEvents(list) {
    const tbody = document.querySelector("#events-table-body");
    if (!tbody) return;

    if (!list || list.length === 0) {
        tbody.innerHTML = "";
        return;
    }

    tbody.innerHTML = list.map(ev => `
        <tr>
            <td>${ev.timestamp}</td>
            <td>${ev.ip}</td>
            <td>${ev.action}</td>
            <td>${ev.description}</td>
        </tr>
    `).join("");
}

// -------------------- FULL STATE REFRESH --------------------

function fetchState() {
    fetch("http://127.0.0.1:5000/state")
        .then(resp => resp.json())
        .then(data => {

            // update atack counter
            updateAttacksToday(data.attacks_today);

            // update banned IPs
            updateBannedIPs(data.banned_ips);

            // update events table
            updateEvents(data.events);

            // update chart data
            chart.data.labels = data.chart.labels;
            chart.data.datasets[0].data = data.chart.values;
            chart.update("none");
        })
        .catch(err => console.error("Error updating state:", err));
}

// -------------------- INIT --------------------

createChart(
    JSON.parse('{{ chart_labels | tojson | safe }}'),
    JSON.parse('{{ chart_values | tojson | safe }}')
);

setInterval(fetchState, 5000);

</script>


{% endblock %}
